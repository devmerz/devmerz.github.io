I"3<p>En este articulo aprenderás como configurar y crear una aplicacion hecha con Apache Cordova capaz de recibir notificaciones push, mediante la plataforma Firebase (FCM).</p>

<p><br /></p>

<p><img src="/assets/apache-cordova-push-android-fcm/imagen-principal.png" /></p>

<p>En el siguiente articulo usted aprendera como Configurar un Proyecto en Console Developers Google y  <a href="https://firebase.google.com/docs/cloud-messaging/" target="_blank">Firebase Google Cloud Messaging</a> para enviar notificaciones PUSH a dispositivos Android, a traves de FCM.</p>

<p><br /></p>

<h1 id="configurar-proyecto-en-firebase-console">Configurar proyecto en Firebase Console</h1>

<p>Nos dirigimos a <a href="https://console.firebase.google.com" target="_blank">Firebase console</a></p>

<p><img src="/assets/push-apache-cordova-actualizado/crear-proyecto.png" /></p>

<p>Nuestro proyecto se llamará <strong>Notificaciones push cordova</strong>, luego presionamos en continuar:</p>

<p><img src="/assets/push-apache-cordova-actualizado/nombre-proyecto.png" /></p>

<p>Nos pedirá integrar el proyecto con Google Analytics, en este caso no lo habilitaremos, presionamos en <strong>Crear proyecto</strong>, una vez terminado el proceso el proyecto estará creado: presionamos en continuar</p>

<p><img src="/assets/push-apache-cordova-actualizado/proyecto-creado.png" /></p>

<p>Seleccionamos la opción <strong>Configuración del proyecto</strong>
<img src="/assets/push-apache-cordova-actualizado/configuracion-proyecto.png" /></p>

<p>Nos vamos al pestaña General al final se encuentra la opcion para crear la configuracion para la aplicacion, en este caso seleccionamos la opcion Android:</p>

<p><img src="/assets/push-apache-cordova-actualizado/android-proyecto.png" /></p>

<h3 id="registrar-app">Registrar app</h3>
<p>En el formulario que nos presenta solo llenamos el campo <strong>paquete del proyecto android</strong>, los demas campos son opcionales, presionamos <strong>Registrar app</strong>
<img src="/assets/push-apache-cordova-actualizado/registrar-app.png" /></p>

<h3 id="descargar-archivo-google-servicesjson">Descargar archivo google-services.json</h3>
<p><img src="/assets/push-apache-cordova-actualizado/descargar-google-services.png" />
ok, guarda el archivo google-services.json que mas adelante lo pondremos en la raiz del proyecto.</p>

<h1 id="crear-aplicación">Crear aplicación</h1>

<p>Ejecutamos los siguientes comandos:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">cordova</span> <span class="n">create</span> <span class="n">miproyecto</span> <span class="n">com</span><span class="p">.</span><span class="nf">notificacionespushcordova</span><span class="p">.</span><span class="nf">app</span> <span class="n">miapp</span>
<span class="n">cd</span> <span class="n">miproyecto</span>
<span class="n">cordova</span> <span class="n">platform</span> <span class="n">add</span> <span class="n">android</span>
<span class="n">cordova</span> <span class="n">plugin</span> <span class="n">add</span> <span class="n">cordova</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">firebasex</span>
<span class="n">cordova</span> <span class="n">run</span> <span class="n">android</span></code></pre></figure>

<p>En este punto se te presentará el siguiente error:</p>

<blockquote>
  <p>This project uses AndroidX dependencies, but the ‘android.useAndroidX’ property is not enabled. Set this property to true in the gradle.properties file and retry.</p>
</blockquote>

<p>Para solucionar este error tenemos que modificar el archivo config.xml, devemos adicionar la linea:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="n">preference</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"AndroidXEnabled"</span> <span class="n">value</span><span class="o">=</span><span class="s2">"true"</span> <span class="o">/&gt;</span></code></pre></figure>

<p>Quedando el archivo asi:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="p">?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s1">'1.0'</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">widget</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"com.notificacionespushcordova.app"</span> <span class="n">version</span><span class="o">=</span><span class="s2">"1.0.0"</span> <span class="n">xmlns</span><span class="o">=</span><span class="s2">"http://www.w3.org/ns/widgets"</span> <span class="n">xmlns</span><span class="ss">:cdv</span><span class="o">=</span><span class="s2">"http://cordova.apache.org/ns/1.0"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">name</span><span class="o">&gt;</span><span class="n">miapp</span><span class="o">&lt;</span><span class="sr">/name&gt;
    &lt;description&gt;
        A sample Apache Cordova application that responds to the deviceready event.
    &lt;/</span><span class="n">description</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">author</span> <span class="n">email</span><span class="o">=</span><span class="s2">"dev@cordova.apache.org"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"http://cordova.io"</span><span class="o">&gt;</span>
        <span class="no">Apache</span> <span class="no">Cordova</span> <span class="no">Team</span>
    <span class="o">&lt;</span><span class="sr">/author&gt;
    &lt;content src="index.html" /</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">access</span> <span class="n">origin</span><span class="o">=</span><span class="s2">"*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"http://*/*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"https://*/*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"tel:*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"sms:*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"mailto:*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"geo:*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">platform</span> <span class="nb">name</span><span class="o">=</span><span class="s2">"android"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"market:*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="sr">/platform&gt;
    &lt;platform name="ios"&gt;
        &lt;allow-intent href="itms:*" /</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">allow</span><span class="o">-</span><span class="n">intent</span> <span class="n">href</span><span class="o">=</span><span class="s2">"itms-apps:*"</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="sr">/platform&gt;
    &lt;preference name="AndroidXEnabled" value="true" /</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/widget&gt;</span></code></pre></figure>

<p>Si volvemos a volvermos a ejecutar: cordova run android, se ejecutara sin problemas:</p>

<p><img src="/assets/push-apache-cordova-actualizado/app-proyecto.png" /></p>

<p>Perfecto, ahora un poco de código. En el archivo index.js vamos a cambiar el contenido original por:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">document</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="s1">'deviceready'</span><span class="p">,</span> <span class="n">onDeviceReady</span><span class="p">,</span> <span class="kp">false</span><span class="p">);</span>

<span class="n">function</span> <span class="n">onDeviceReady</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s1">'deviceready'</span><span class="p">).</span><span class="nf">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">);</span>

     <span class="n">window</span><span class="o">.</span><span class="no">FirebasePlugin</span><span class="p">.</span><span class="nf">getToken</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="s2">"miToken"</span><span class="p">).</span><span class="nf">value</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
    <span class="p">},</span> <span class="n">function</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="n">window</span><span class="o">.</span><span class="no">FirebasePlugin</span><span class="p">.</span><span class="nf">onTokenRefresh</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"Actualizar para obtener nuevo token: "</span> <span class="o">+</span> <span class="n">token</span><span class="p">);</span>
    <span class="p">},</span> <span class="n">function</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">alert</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="n">window</span><span class="o">.</span><span class="no">FirebasePlugin</span><span class="p">.</span><span class="nf">onMessageReceived</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">messageType</span> <span class="o">===</span> <span class="s2">"notification"</span><span class="p">){</span>
            <span class="n">alert</span><span class="p">(</span><span class="s2">"Notificación recibida dentro de la aplicación"</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nf">tap</span><span class="p">){</span>
                <span class="n">alert</span><span class="p">(</span><span class="s2">"Presionada en: "</span> <span class="o">+</span> <span class="n">message</span><span class="p">.</span><span class="nf">tap</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="n">function</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
    <span class="p">});</span> 
<span class="p">}</span></code></pre></figure>

<h1 id="test">Test</h1>
:ET